# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

pool:
  vmImage: 'Ubuntu 16.04'

steps:
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.4.5'
   
- script: |
    sudo apt-get update
    sudo apt-get install postgresql postgresql-contrib libpq-dev
  displayName: 'Install Postgres'
  
- script: |
    sudo pkexec --user postgres psql -f ./postgres_setup_azure.sql
    exit
  displayName: 'Setup Postgres'
  
- script: |
    gem install bundler
    gem install pg
    gem install rails
  displayName: 'Install Dependencies and Rails'
  
- script: bundle
  displayName: 'Install required gems'
   
- script: |
    rails db:create
    rails db:migrate
  displayName: 'Create database and migrate data'
  
- script: |
    rails exec rspec
  displayName: 'Test with rspec'
